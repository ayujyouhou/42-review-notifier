# Google Apps Script 版 - Gmail → Discord 通知 Bot

## 構成の比較

| 項目 | Python版 | GAS版 ✅ |
|------|---------|---------|
| 費用 | GCE e2-micro 無料枠 | **完全無料** |
| Gmail認証 | OAuth設定が複雑 | **不要（同じアカウント）** |
| サーバー | 必要 | **不要** |
| 定期実行 | 自前で実装 | **トリガー機能** |
| メンテ | VMの管理必要 | **ほぼ不要** |

## セットアップ手順

### 1. Discord Webhook 作成

1. Discord で通知したいチャンネルを開く
2. ⚙️ チャンネルの編集 → **連携サービス** → **ウェブフック**
3. **新しいウェブフック** → 名前を設定
4. **ウェブフックURLをコピー**

### 2. ユーザーID 取得（メンション用）

1. Discord設定 → 詳細設定 → **開発者モード ON**
2. 自分のアイコンを右クリック → **IDをコピー**

### 3. Google Apps Script プロジェクト作成

1. https://script.google.com にアクセス
2. **新しいプロジェクト** をクリック
3. プロジェクト名を「Gmail Discord Bot」などに変更
4. `main.gs` の内容を全て貼り付け

### 4. 設定を編集

`CONFIG` オブジェクトを編集：

```javascript
const CONFIG = {
  // Discord Webhook URL
  DISCORD_WEBHOOK_URL: 'https://discord.com/api/webhooks/xxxxx/xxxxx',
  
  // メンションするユーザーID
  DISCORD_USER_ID: '123456789012345678',
  
  // 検索するメールの件名キーワード
  EMAIL_SUBJECT_FILTER: '予約確認',
  
  // 何分前に通知するか
  REMINDER_MINUTES_BEFORE: 5,
  
  // 検索する過去のメール（時間）
  SEARCH_HOURS: 24,
};
```

### 5. テスト実行

1. 関数選択で `testNotification` を選択
2. **実行** をクリック
3. 初回は **権限の確認** が必要
   - 「詳細」→「（プロジェクト名）に移動」→「許可」
4. Discord にテスト通知が届けばOK！

### 6. トリガー設定（定期実行）

1. 左メニュー ⏰ **トリガー** をクリック
2. **トリガーを追加** をクリック

#### メールチェック用（5分おき）
- 実行する関数: `checkEmails`
- イベントのソース: 時間主導型
- 時間ベースのトリガータイプ: **分ベースのタイマー**
- 間隔: **5分おき**

#### リマインダー用（1分おき）
- 実行する関数: `sendScheduledReminder`
- イベントのソース: 時間主導型
- 時間ベースのトリガータイプ: **分ベースのタイマー**
- 間隔: **1分おき**

## 動作フロー

```
[Gmail] ← 5分おきにチェック ← [GAS: checkEmails]
    ↓
  未読の特定件名メール発見
    ↓
  ┌─────────────────────────────┐
  │ 1. 新着メール通知を送信      │ → [Discord Webhook]
  │ 2. 日時を抽出               │
  │ 3. 5分前リマインダーを保存   │
  └─────────────────────────────┘
    
[GAS: sendScheduledReminder] ← 1分おきに実行
    ↓
  保存されたリマインダーを確認
    ↓
  時刻が来たら通知 → [Discord Webhook]
```

## デバッグ

### ログ確認
- 左メニュー **実行数** をクリック
- 各実行のログを確認可能

### データ確認
```javascript
// 関数 checkData を実行
checkData();
```

### データクリア
```javascript
// 関数 clearAllData を実行
clearAllData();
```

## 制限事項

- GAS の実行時間制限: 6分/回
- トリガー制限: 20個/ユーザー
- 1日の実行回数: 無料アカウントで十分

## トラブルシューティング

### 通知が来ない
1. Webhook URL が正しいか確認
2. ログで「Discord送信成功」が出ているか確認
3. メールが「未読」か確認

### メンションされない
1. ユーザーIDが正しいか確認
2. Webhook の権限を確認

### 日時が抽出されない
- 対応フォーマット:
  - `2024年12月7日 14:30`
  - `2024/12/07 14:30`
  - `12月7日(土) 14:30`
  - `12月7日 14:30`
- 他のフォーマットは `extractDateTime` 関数にパターン追加
