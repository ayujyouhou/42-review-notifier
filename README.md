# 42 Review Notifier - Gmail → Discord 通知 Bot

42 Tokyoの評価予約メールを自動検知し、Discordに通知するGoogle Apps Scriptです。

## 機能

- 📧 **予約確定時に即通知**: メール受信時にメンション付きで通知
- ⏰ **10分前リマインダー**: 評価開始10分前に再度メンション通知
- 🔔 **完全無料**: Google Apps Scriptで動作、サーバー不要

## 対応メール形式

**件名**: `You have a new booking`

**本文例**:
```
Hi, You will review somebody's code from December 07, 2025 11:45 for 30 minutes.
```

自動で以下を抽出:
- 📅 予定時刻: `December 07, 2025 11:45`
- ⏱️ 所要時間: `30 minutes`

## セットアップ手順

### 1. Discord Webhook 作成

1. Discord で通知したいチャンネルを開く
2. ⚙️ チャンネルの編集 → **連携サービス** → **ウェブフック**
3. **新しいウェブフック** → 名前を設定
4. **ウェブフックURLをコピー**

### 2. ユーザーID 取得（メンション用）

1. Discord設定 → 詳細設定 → **開発者モード ON**
2. 自分のアイコンを右クリック → **IDをコピー**

### 3. Google Apps Script プロジェクト作成

1. https://script.google.com にアクセス（42のメールを受信するGoogleアカウント）
2. **新しいプロジェクト** をクリック
3. プロジェクト名を「42 Review Notifier」などに変更

### 4. ファイルを追加

#### config.js を作成
1. GASエディタで「ファイル」→「新規」→「スクリプト」
2. ファイル名を `config` に変更
3. `config.example.js` の内容をコピーして貼り付け
4. 各項目を自分の設定に変更：

```javascript
const CONFIG = {
  // Discord Webhook URL
  DISCORD_WEBHOOK_URL: 'https://discord.com/api/webhooks/xxxxx/xxxxx',
  
  // メンションするユーザーID
  DISCORD_USER_ID: '123456789012345678',
  
  // 検索するメールの件名キーワード（42のメール）
  EMAIL_SUBJECT_FILTER: 'You have a new booking',
  
  // 何分前に通知するか
  REMINDER_MINUTES_BEFORE: 10,
  
  // 検索する過去のメール（時間）
  SEARCH_HOURS: 24,
};
```

#### main.js を追加
1. デフォルトの `コード.gs` に `main.js` の内容を貼り付け
2. ファイル名を `main` に変更（任意）

### 5. テスト実行

1. 関数選択で `testNotification` を選択
2. **実行** をクリック
3. 初回は **権限の確認** が必要
   - 「詳細」→「（プロジェクト名）に移動」→「許可」
4. Discord にテスト通知が届けばOK！

### 6. トリガー設定（定期実行）

1. 左メニュー ⏰ **トリガー** をクリック
2. **トリガーを追加** をクリック

#### メールチェック用（5分おき）
- 実行する関数: `checkEmails`
- イベントのソース: 時間主導型
- 時間ベースのトリガータイプ: **分ベースのタイマー**
- 間隔: **5分おき**

#### リマインダー用（1分おき）
- 実行する関数: `sendScheduledReminder`
- イベントのソース: 時間主導型
- 時間ベースのトリガータイプ: **分ベースのタイマー**
- 間隔: **1分おき**

## 動作フロー

```
📧 42から予約メール到着: "You have a new booking"
    ↓
[GAS: checkEmails] ← 5分おきに実行
    ↓
  未読メールを発見
    ↓
  ┌─────────────────────────────────────┐
  │ 1. 日時を抽出（December 07, 11:45）  │
  │ 2. Discord通知（即座・メンション）   │ → 💬 予約確定通知
  │ 3. 10分前リマインダーを保存         │
  └─────────────────────────────────────┘
    
[GAS: sendScheduledReminder] ← 1分おきに実行
    ↓
  スケジュールを確認
    ↓
  10分前になったら → 💬 リマインダー通知（メンション）
```

## 通知例

### 1. 予約確定時（即座）
```
@あなた 🔔 42 Evaluation 予約確定
📅 予定時刻: 2025年12月07日 11:45
⏱️ 所要時間: 30分
⏰ 10分前にメンション通知します
```

### 2. 10分前
```
@あなた ⏰ 予定の10分前です！
予定時刻: 2025年12月07日 11:45
```

## デバッグ

### ログ確認
- 左メニュー **実行数** をクリック
- 各実行のログを確認可能

### データ確認
```javascript
// 関数 checkData を実行
checkData();
```
42のメールが「未読」か確認
4. 件名が `You have a new booking` か確認

### メンションされない
1. ユーザーIDが正しいか確認
2. Webhook の権限を確認

### 日時が抽出されない
- 対応フォーマット:
  - `from December 07, 2025 11:45`（42のメール形式）
  - `2024年12月7日 14:30`（日本語）
  - `2024/12/07 14:30`
  - `12月7日 14:30`

## ライセンス

MIT License
## トラブルシューティング

### 通知が来ない
1. Webhook URL が正しいか確認
2. ログで「Discord送信成功」が出ているか確認
3. メールが「未読」か確認

### メンションされない
1. ユーザーIDが正しいか確認
2. Webhook の権限を確認

### 日時が抽出されない
- 対応フォーマット:
  - `2024年12月7日 14:30`
  - `2024/12/07 14:30`
  - `12月7日(土) 14:30`
  - `12月7日 14:30`
- 他のフォーマットは `extractDateTime` 関数にパターン追加
